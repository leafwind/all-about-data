# Data Pipeline Design Rules & Check List

#### 

---

# Rules

## Rule \#1 åšå¥½ data pruning çš„æº–å‚™ / åŸ¹é¤Š data fetch cost çš„æ¦‚å¿µ

æ²’æœ‰åšé data pipeline çš„å·¥ç¨‹å¸«ï¼Œåœ¨åšä¸€å€‹æœå‹™çš„æ™‚å€™

å¾ˆè‡ªç„¶æœƒæƒ³è¦æŠŠè³‡æ–™å…ˆå…¨éƒ¨è’é›†èµ·ä¾†ï¼Œç„¶å¾Œå†æ…¢æ…¢è™•ç†é‚è¼¯

ä½†é€™éº¼åšå¾ˆå¸¸æ˜¯ä¸åˆ‡å¯¦éš›çš„

çš„ç¢ºï¼Œæ©Ÿå™¨æˆæœ¬è¶Šä¾†è¶Šä½ï¼Œå¾ˆå¤šæŠ€è¡“ä¹Ÿéƒ½å·²ç¶“ scalableï¼Œä½†æŠ€è¡“ä¸Šåšå¾—åˆ°ï¼Œä¸ä»£è¡¨é ç®—åšå¾—åˆ°

æ‰€ä»¥å¸¸æœƒé¢è‡¨åˆ°ç„¡æ³•è™•ç†å®Œæ‰€æœ‰è³‡æ–™çš„æƒ…å½¢


æŠŠ fetch cost æœ€ä½çš„è³‡æ–™å…ˆæ‹¿åˆ°ï¼Œä¸éœ€è¦çš„æ”¯ç·šç æ‰ï¼Œfetch cost æœ€é«˜çš„æ“ºåœ¨æœ€å¾Œè™•ç†

é€šå¸¸å¯ä»¥åªç”¨åˆ°åŸæœ¬çš„ 10% ç”šè‡³ 1% æ©Ÿå™¨



èˆ‰ä¾‹ä¾†èªªï¼Œå‡è¨­æ‰‹ä¸Šæœ‰ä¸€å¹´çš„è³‡æ–™ï¼Œä½†é è¶…å‡ºå¯ä»¥è² è·çš„æ™‚é–“èˆ‡é ç®—

é‚£éº¼å¦‚æœæ™‚æ•ˆæ€§é‡è¦çš„ï¼Œå¯ä»¥è€ƒæ…®åªç•™ä¸‹æœ€è¿‘ä¸€å€‹æœˆçš„è³‡æ–™å³å¯

æˆ–è€…æƒ³è¦åˆ†æ CTRï¼Œé‚£éº¼åªè¦ç•™ä¸‹ä½¿ç”¨è€…çœ‹éçš„ log å³å¯

æˆ–æ˜¯ä¸€ä¸€èª¿æ•´å®¢æˆ¶çš„æ¡ˆå­ï¼Œé‚£éº¼åªè¦æ‹¿ç›®å‰é‚„æœ‰åœ¨è·‘çš„æ¡ˆå­å³å¯

é€™äº›çœ‹ä¼¼ç°¡å–®ï¼Œä½†è‹¥ä¸çŸ¥é“è³‡æ–™çš„æ„ç¾©ï¼Œå»å¾ˆå®¹æ˜“è¢«å¿½ç•¥

## Rule #2 åŸ¹é¤Šæ‰¾å°‹å‚™æ¡ˆï¼ˆfallback planï¼‰çš„èƒ½åŠ›

å¦‚æœæ˜¯åœ¨ä¸€é–“çµ„ç¹”åˆ†å·¥æ˜ç¢ºã€éœ€æ±‚è¢«æ¸…æ¥šå®šç¾©çš„å…¬å¸

é‚£å¯èƒ½å¯ä»¥å‡è¨­éœ€è¦çš„è³‡æ–™ä¸€å®šéš¨æ™‚éƒ½èƒ½æ‹¿åˆ°ï¼Œæ‰€æœ‰æœå‹™ä¹Ÿéƒ½å¾ˆé›£æœƒæœ‰ downtime

ä½†å¤§éƒ¨åˆ†å…¬å¸éƒ½ä¸æ˜¯å¦‚æ­¤ï¼ˆè‡³å°‘å°ç£ä¸æ˜¯ï¼‰

æœ‰æ™‚å€™æ˜¯ç³»çµ±ä¸ç©©å®šã€è‡ªå·±å¯«çš„ç¨‹å¼ä¸ç©©å®š

æœ‰æ™‚å€™æ˜¯å¤–éƒ¨ä¾†çš„è³‡æ–™ä¸ç©©å®š

å†æœ‰æ™‚å€™æ˜¯æˆé•·å¿«é€Ÿã€éœ€æ±‚è®Šå‹•é »ç¹ï¼Œå³ä½¿ç³»çµ±æ²’æœ‰å‡ºç‹€æ³ï¼Œä¹Ÿå¾ˆå®¹æ˜“ä¸æ•·ä½¿ç”¨

å› æ­¤

éœ€è¦ A è³‡æ–™ï¼Œä½†åŸæœ¬æŠ“å–ä¸€æ¬¡å›æ‡‰æ™‚é–“åªè¦ 1sï¼Œç¾åœ¨è®Šæˆ 10s æ€éº¼è¾¦

éœ€è¦ B è³‡æ–™ï¼Œä½†æœ‰ 10% çš„æ©Ÿæœƒæ‹¿ä¸åˆ°è¦ retryï¼Œç”šè‡³ç„¡æ³•åŒæ­¥æ‹¿åˆ°ï¼Œåªèƒ½æ”¹ç”¨éåŒæ­¥

# Check Lists

## Data Generationï¼ˆä¸åªæ˜¯ç”Ÿè³‡æ–™ï¼Œé‚„è¦å•æ€éº¼ç”Ÿï¼‰

* Freshness(Delay)

  * ä¸Šæ¸¸æ‹¿åˆ°è³‡æ–™æ™‚å·²ç¶“å»¶é²å¤šä¹…ï¼Ÿ
  * ä¸‹æ¸¸å¯ä»¥æ¥å—è³‡æ–™å»¶é²å¤šä¹…æ‰æ‹¿åˆ°ï¼Ÿ
  * å¾ç™¼ç”Ÿè¡Œç‚ºåˆ°å®¢æˆ¶çœ‹åˆ°è³‡æ–™è¦å¤šä¹…ä»¥å…§ï¼Ÿ
  
* Frequency

  * ä¸Šæ¸¸å¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ
  * ä¸‹æ¸¸å¯ä»¥æ¥å—å¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ
  
ğŸ‘‰å®¢æˆ¶å¯ä»¥æ¥å—å¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Œéœ€è¦å¤šæ–°çš„è³‡æ–™ï¼Ÿ
æœ‰äº›å¾Œç«¯åˆ†æçµ¦å…¬å¸å…§éƒ¨ä½¿ç”¨ï¼Œå¯èƒ½åªè¦ä¸€å¤©ä¸€æ¬¡ï¼Œä¹Ÿä¸ç”¨ç•¶å¤©å°±è¦çœ‹å¾—åˆ°è³‡æ–™ï¼Œé€™ç¨®éœ€æ±‚å°±æ¯”è¼ƒå¥½è¨­è¨ˆï¼Œæˆæœ¬ä¹Ÿç›¸å°ä½
æœ‰äº›æƒ…æ³æ¯”è¼ƒåé‡å¾Œè€…ï¼Œæ¯”å¦‚å®¢æˆ¶éœ€è¦è‡³å°‘ä»Šå¤©æ™šä¸Šçœ‹å¾—åˆ°æ—©ä¸Šçš„è³‡æ–™
æœ‰äº›å‰‡æ›´æ¥µç«¯ï¼Œæ¯”å¦‚ç•°å¸¸ç‹€æ³åµæ¸¬çš„ log äº”åˆ†é˜å…§å°±è¦èƒ½åæ‡‰åœ¨æ¼”ç®—æ³•ä¸Šï¼Œå¦å‰‡ç·šä¸Šæœå‹™æœƒæœ‰åš´é‡å½±éŸ¿
é€šå¸¸ update frequency çš„éœ€æ±‚ï¼Œå¢åŠ æ©Ÿå™¨å°±å¯ä»¥è§£æ±ºï¼Œä½†è‹¥å°è³‡æ–™çš„ã€Œæ–°é®®åº¦ã€æœ‰æ¯”è¼ƒåš´æ ¼çš„è¦æ±‚ï¼Œå¯èƒ½å°±è¦æ”¹è®Šè¨­è¨ˆï¼Œç”šè‡³ç æ‰é‡ç·´ï¼Œé‡åšä¸€æ¢ç‰¹è£½åŒ–çš„ ETL
æœ‰åƒ¹å€¼çš„éœ€æ±‚å€¼å¾—ç‚ºå®ƒæ‰“é€ ä¸€æ¢è·¯ï¼Œä½†é‡èº«è¨‚åšä¹Ÿå°±ä»£è¡¨é–‹ç™¼ã€ç¶­è­·æˆæœ¬éƒ½æ¯”è¼ƒé«˜

* Timing

  * ä»€éº¼æ™‚é–“ cluster æ¯”è¼ƒå¿™ï¼Ÿ
  * ä»€éº¼æ™‚é–“ä¸Šæ¸¸é‚„æ²’ç”Ÿå‡ºä¾†ä¸ç”¨ç™½è·‘ï¼Ÿ

* Trigger

  * éœ€è¦æœ‰äººé€šçŸ¥ä»–é–‹è·‘å—ï¼Ÿ
  * ä¸Šæ¸¸æœ‰è¾¦æ³•é€šçŸ¥ä»–å—ï¼Ÿ
  * ç¶²è·¯èƒ½é€šå—ï¼Ÿ

### èˆŠè³‡æ–™çš„è¦æ±‚

* Retention Policy

ğŸ‘‰å¤ªèˆŠçš„è³‡æ–™è¦æ€éº¼æ·˜æ±°ï¼Ÿ
ç¾åœ¨ storage ä¸ç®¡åœ¨å“ªéƒ½ç®—æ˜¯ç›¸å°ä¾¿å®œçš„æˆæœ¬
å¦‚æœæ˜¯åªç‰½æ¶‰åˆ°å„²å­˜æˆæœ¬çš„æƒ…æ³
æ¯”å¦‚åƒ s3ï¼Œåªè¦æœ‰è¨­å®šå¥½ retention policyï¼Œé€šå¸¸ä¸ç”¨å¤ªæ–¤æ–¤è¨ˆè¼ƒã€‚
ä½†ä»ç„¶æœ‰ä¸€äº›æƒ…æ³ä¸å¤ªå¥½è™•ç†
ä¾‹å¦‚è¨­è¨ˆä¸è‰¯çš„ MySQLï¼Œç¶“å¹´ç´¯æœˆç™¼ç¾ table è·Ÿ index éƒ½å·²ç¶“éå¸¸è‚¥
é€™æ™‚å€™ã€Œç è³‡æ–™ã€æœ¬èº«å¯èƒ½å°±æ˜¯ä¸€ä»¶éº»ç…©äº‹
è¦ç è³‡æ–™æˆ–æ˜¯æ›´æ”¹ schema å¯èƒ½å°±è¦æ¡å–æ¯”è¼ƒè¿‚è¿´çš„ä½œæ³•

* Backfill Support

  * æœƒéœ€è¦ä»¥å‰çš„è³‡æ–™å—ï¼Ÿ
  * å¦‚æœè¦ï¼Œå¾å¤šä¹…ä»¥å‰é–‹å§‹ï¼Ÿ
  
ğŸ‘‰å¦‚æœéœ€è¦ä»¥å‰æŸæ®µæ™‚é–“çš„è³‡æ–™ï¼Œæœ‰æ²’æœ‰è¾¦æ³•åªæ›´æ–°é‚£ä¸€éƒ¨åˆ†ï¼Ÿ
ä¸Šé¢è¬›çš„æ˜¯å¤šäº†è¦ç 
æœ‰æ™‚å€™ç™¼ç¾éå»æŸæ®µæ™‚é–“çš„è³‡æ–™ä¾†æºè£¡é¢æœ‰åƒåœ¾ï¼Œæˆ–è³‡æ–™çš„å®šç¾©åœ¨å€‹æ™‚é–“é»ä¹‹å¾Œå·å·æ”¹è®Šäº†ï¼Œä½†åˆä¸æƒ³é‡è·‘å…¨éƒ¨
é€™äº›å°‘äº†è¦è£œçš„æƒ…æ³è©²æ€éº¼è¾¦ï¼Ÿ
ETL job æœ‰æ²’æœ‰è¾¦æ³•å½ˆæ€§åœ°æŒ‡å®šæ™‚é–“å»æ›´æ–°è³‡æ–™ï¼Ÿ
æ›´æ–°å®Œæœ‰æ²’æœ‰è¾¦æ³•ç„¡ç—›åœ°æ”¾åˆ°è³‡æ–™åº«æˆ– ETL pipeline ç•¶ä¸­ï¼Ÿinsert æ˜¯å¦è¦è€ƒæ…® key çš„å•é¡Œã€æ•ˆç‡å¥½å—ï¼Ÿæœƒä¸æœƒå½±éŸ¿ç·šä¸Šæœå‹™ï¼Ÿ

æœ‰äº›å„²å­˜åª’ä»‹çš„é™åˆ¶èˆ‡è¨­è¨ˆä¸¦æ²’æœ‰è¾¦æ³•å¾ˆè¼•é¬†åœ° backfill
å¦å¤–ä¸€äº›ä¸€é–‹å§‹å°±è¨­è¨ˆä¸è‰¯çš„æƒ…æ³ï¼Œæœ€æ…˜å°±æ˜¯å…¨éƒ¨é‡è·‘



## Connectivityï¼ˆä¸Šä¸‹æ¸¸éœ€æ±‚æœ‰å•æ¸…æ¥šå—ï¼Ÿï¼‰

ä¸Šæ¸¸æ›´æ–°é »ç‡ã€delayï¼Œä½•æ™‚é–‹å§‹è·‘æ‰ä¸æœƒç‚¸
ä¸‹æ¸¸éœ€æ±‚çš„æ›´æ–°é »ç‡ã€éœ€æ±‚ delayï¼Œå¦‚ä½•é€šçŸ¥ä»–

#### å·¥å…·ï¼š

airflow dag, jenkins trigger/polling


## Pipeline Healthy (Monitor/Alert)

åœ¨é‡è¦çš„ç’°ç¯€åŠ å…¥ log æ˜¯å¾ˆåˆç†è€Œä¸”ç›´è§€çš„

ç†è«–ä¸Š Airflow, Prometheus å¯ä»¥å¹«åŠ©åšåˆ°é€™ä»¶äº‹æƒ…

ä½†ç¤™æ–¼æ™‚é–“é™åˆ¶ï¼Œæœ‰æ™‚å€™ä¸å¯èƒ½åœ¨æ‰€æœ‰è³‡æ–™ç”Ÿæˆçš„æ™‚å€™éƒ½é€™æ¨£åš
ï¼ˆe.g. æœ‰äº› ETL åœ¨è³‡æ–™åº«è£¡é¢æŸ¥è©¢åšè½‰æ›ã€æœ‰äº›ç”šè‡³åœ¨æ‡‰ç”¨ç¨‹å¼é‚è¼¯è£¡é¢å·å·åšè½‰æ›ï¼‰

å› æ­¤å¸¸å¸¸æ˜¯çˆ†ç‚¸ä¹‹å¾Œä¸€è·¯å¾ªç·šä¸Šå»æŸ¥æ‰ç™¼ç¾æŸå€‹åœ°æ–¹æœ‰å•é¡Œ

æœ‰å“ªäº›å¸¸è¦‹éœ€è¦è¨˜éŒ„çš„å•é¡Œï¼Ÿ

data discrepancy

> å°‘äº†å¹¾ç­†

schema error
> å®Œå…¨ä¸åˆè¦ç¯„çš„éæ³•è³‡æ–™

data inconsistency

> ä¸é‚£éº¼åš´é‡ä½†æ˜¯é‚è¼¯ä¸Šæœ‰ç‘•ç–µçš„å•é¡Œ

performance / expectedÂ time

> ç”Ÿå¤ªæ…¢ã€æ²’æœ‰åœ¨é æœŸæ™‚é–“å…§ç”¢å‡º

## Data Storage

#### SQL

* Index

  * explain query first
  * Index æœ‰é †åºçš„æ¦‚å¿µï¼ŒQuery æ˜¯å¦æœ‰æŒ‰ç…§é †åºï¼ˆi.e. 1 or 1+2 or 1+2+3ï¼‰ï¼Ÿ

* Partition

  * å–®å¼µ table å¤ªå¤§æ™‚è¦åˆ‡ partition å—ï¼Ÿ
  * è‡ªå‹• event å®šæ™‚å¢åŠ  partition é‚„æ˜¯æ‰‹å‹•ï¼ŸAWS RDS æ€éº¼è¨­å®šï¼Ÿ
  * partition size?
  * partition key?
  * å¦‚æœåŸæœ¬æ²’æœ‰ partition è¦æ€éº¼ migrate table?



